---
title: 硬引用和软引用
date: 2025-11-24 21:44:00 +0800
categories: [UE开发技巧, 游戏开发, 游戏客户端开发]
tags: [UE5.6,Unreal,UE C++]
pin: true
author: Fall'in A Peace

toc: true
comments: true
typora-root-url: ../../fap8235.github.io
math: false
mermaid: false

---

# Hard Reference

## 使用案例

### 案例一：蓝图Cast

- 选中某个`Actor`，鼠标右键打开尺寸贴图，便可得到可视化的Hard Reference

  ![image-20251121111646715](/assets/blog_res/image-20251121111646715.png)

- 可看到该`Actor`蓝图占用110MB的内存，而这些占用主要来源于`BP_ThirdPersonCharacter`

- `Actor`在`Cast`时保留了`BP_ThirdPersonCharacter`的Hard Reference，在加载`Actor`时也会一并加载`BP_ThirdPersonCharacter`，即便不需要使用

  [^ 原因]: 进行`Cast`时，为了让蓝图资产知道另一个蓝图资产的存在并访问其函数或变量，需要先加载被访问的蓝图



### 案例二：蓝图编辑器中制作Hard Reference

- 在如下函数中，选择相应的类引用

  ![image-20251121112509162](/assets/blog_res/image-20251121112509162.png)

- 或者通过接口函数传递BP对象引用

  ![image-20251121112534346](/assets/blog_res/image-20251121112534346.png)

- 此外，BP继承也可能导致编辑中Hard Reference

  例如创建蓝图`Actor`的子类`Actor_Child`时



### 案例三：C++生成武器类别

在C++中声明武器`Actor`类别后，交由蓝图编辑选择类别时也会造成Hard Reference

```C++
UPROPERTY(EditAnywhere, Category = "Combat")
TSubClassOf<AActor> MyWeaponActorClass;
```

![image-20251121113738024](/assets/blog_res/image-20251121113738024.png)

- 这里可以用Soft Reference改进

### 避免Hard Reference的方法

1. 尽量使用接口而不`Cast`（但其实也有可能产生Hard Reference）
2. 将`Actor` `Cast`为原生C++类或者成本低的BP父类
3. 避免通过BP接口传递BP对象引用
4. 尽量将业务逻辑保存在BP父类中



### 如何正确使用 Hard Reference

正确方法：

- `Actor`引用`BP_ThirdPersonCharacter`，因为角色的纹理等可能需要及时加载



错误方法：

- 在主菜单中保留Boss角色的Hard Reference，这意味着在加载角色菜单时Boss的数据也要一并加载到内存



# Soft Reference

## 使用案例

- 只指向资产的路径，默认不加载，每次都需要手动加载

![image-20251121114006121](/assets/blog_res/image-20251121114006121.png)

- Soft Reference仅会得到一个小球：

  ![image-20251121114100841](/assets/blog_res/image-20251121114100841.png)

### 案例一：在C++中使用`TSoftObjectPtr`

- 在C++中编写代码：

  ```c++
  UPROPERTY(EditAnyWhere, Category = "Combat")
  TSoftObjectPtr<UTexture2D*> MySoftTextureObjectPtr;	// 使用TSoftObjectPtr
  ```



### 案例二：在蓝图编辑器中更改变量类型

- 在蓝图编辑器中，将变量转为`Soft Object Reference`类型

  ![image-20251124224416495](/assets/blog_res/image-20251124224416495.png)



# Hard和Soft Reference对比

|          | Hard Reference                                               | Soft Reference                                               |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **优点** | - 能更简便访问对象<br />- 在需要时资产能确保被加载出来<br />- 适用于关键资产 | - 资产只在需要时加载<br />- 适用于不是立马需要的资产         |
| **缺点** | - 造成不必要的内存浪费<br />- 造成长时间加载                 | - 使代码变复杂<br />- 时间难以控制，可能会晚几帧加载<br />- 不适用于关键资产：角色网格、使用材质、角色类别、游戏模式 |



